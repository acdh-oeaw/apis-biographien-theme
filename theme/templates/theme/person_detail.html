{% extends "theme/base.html" %}
{% load leaflet_tags %}
{% block scriptHeader %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/three@latest/build/three.min.js"></script>
  <script crossorigin src="https://unpkg.com/@acdh/network-visualization@latest/lib/network-visualization.umd.js"></script>
  {% leaflet_js %}
  {% leaflet_css %}
{% endblock %}
{% load staticfiles %}
{% load webpage_extras %}
{% load custom_tags %}
{% block title %}{{ object }}{% endblock %}
{% block content %}
<div id="contentDetails" class="container pt-5">
  <div class="row bio-outer p-5">
    <div class="col-md-12 pb-4">
      <div class="row justify-content-between">
        <div class="col-md-auto">
          {% if prev.id %}
          <a class="card-link preventity" href="{% url 'theme:person-detail' pk=prev.id %}" title="{{ prev }}">
            &larr; {{ prev }}
          </a>
          {% endif %}
        </div>
        <div class="col"></div>
        <div class="col-md-auto">
          {% if next.id %}
          <a class="card-link nextentity" href="{% url 'theme:person-detail' pk=next.id %}" title="{{ next }}">
            {{ next }} &rarr;
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-8 pr-5">
      <article class="bio">
        <div class="entry-header">
          <div class="row">
            <div class="col">
              <h2>{{ object.name }}{%if object.first_name %}, {{ object.first_name }}{% endif %}</h2>
              <p class="profession-date-of-birth">
                {{ profession }}, <abbr
                title='geboren'>geb.</abbr> {% if place_of_birth is not None %} {{place_of_birth}}, {% endif %}{{object.start_date_written }}; <abbr
                title='gestorben'>gest.</abbr> {% if place_of_death is not None %} {{place_of_death}}, {% endif %}{{object.end_date_written }}
              </p>
            </div>
          </div>
        </div>
        <div class="card-body p-0 pt-3">
          <p class="p-0">{{ main_text }}</p>
        </div>
        <div class="mt-5 text-secondary">
          <hr class="m-5" />
          {{ object.source.pubinfo }}<br>
          {{ object.source.author }}<br>
          {{ object.references }}
        </div>
      </article>
    </div>
    <div class="col-md-4">
      <article>
        <div class="inline-map card-inner relentitiescard card-vertical d-flex flex-column justify-content-between">
          {% leaflet_map "main" %}
        </div>
        <div class="card-inner relentitiescard card-vertical  d-flex flex-column justify-content-between">
          <div class="entry-content pl-2 pt-4">
            <h4>Links</h4>
            <ul class="uris pl-0">{% for uri in object.uri_set.all %}
              <li class="pl-0"><a target="_blank" rel="noopener noreferrer" href="{{uri}}">{{uri}}</a></li>
              {% endfor %}
            </ul>
            {% if related_persons %}
            <h4>Personen</h4>
            <ul class="relentities">
              {% for x in related_persons %}
              <li class="pl-0">

                {{ x.relation_type }} <i style="color: darkred">></i> <strong>{{ x.related_place }}</strong>
                {% formated_daterange x.start_date_written x.end_date_written %}
              </li>
              {% endfor %}
            </ul>
            {% endif %}
            {% if related_places %}
            <h4>Orte</h4>
            <ul class="relentities">
              {% for x in related_places %}
              <li class="pl-0">
                {{ x.relation_type }} <i style="color: darkred">></i> <strong>{{ x.related_place }}</strong>
                 {% formated_daterange x.start_date_written x.end_date_written %}
              </li>
              {% endfor %}
            </ul>
            {% endif %}
            {% if related_institutions %}
            <h4>Institutionen</h4>
            <ul class="relentities">
              {% for x in related_institutions %}
              <li class="pl-0">
                {{ x.relation_type }} <i style="color: darkred">></i> <strong>{{x.related_institution }}</strong>
                {% formated_daterange x.start_date_written x.end_date_written %}
              </li>
              {% endfor %}
            </ul>
            {% endif %}
          </div>
        </div>
      </article>
    </div>
  </div>
</div>

{% endblock content %}
{% block scripts %}
  <script>
    const getNetworkViz = (pers_id, relationtype, t1) => {
    document.getElementById("visualization").style.height = "400px";
    const basePath = 'http://127.0.0.1:8000'
    const endpoint = '/apis/api/relations/'+relationtype
    const query = {
    format: 'json+net',
    related_person__id: pers_id,
    };
    if (relationtype == "personperson") {
    query['related_personA__id'] = pers_id
    }
    const url = new URL(endpoint, basePath)
    Object.keys(query).forEach(key => {
    url.searchParams.set(key, query[key])
    })
    fetch(url)
    .then(response => {
      if (!response.ok) {
      throw new Error(response.statusText)
      }
      return response.json()
    })
    .then(data => {
      const edges = {}
      const nodes = {}
      const types = {edges: {}, nodes: {}}
      data.results.forEach(relation => {
      const {id, source, target, relation_type: relationType} = relation
      edges[id] = {
        id,
        source: source.id,
        target: target.id,
        type: relationType.id,
      }
      nodes[source.id] = {
        id: source.id,
        label: source.label,
        type: 'Person',
      }
      nodes[target.id] = {
        id: target.id,
        label: target.label,
        type: t1,
      }
      types.edges[relationType.id] = {
        id: relationType.id,
        label: relationType.label,
      }
      types.nodes['Person'] = {
        id: 'Person',
        label: 'Person',
        color: 'hotpink',
      }
      types.nodes['Place'] = {
        id: 'Place',
        label: 'Place',
        color: 'rebeccapurple',
      }
      types.nodes['Institution'] = {
        id: 'Institution',
        label: 'Institution',
        color: 'green',
      }
      })
      ReactDOM.render(
      React.createElement(NetworkVisualization.Visualization, {
        graph: {
          edges,
          nodes,
          types,
        },
      }),
      document.getElementById('visualization')
      )
    })
    .catch(error => {
      console.error(error)
    })
  }
  </script>
  <script type="text/javascript">
    var dataurl = "{% url 'apis:apis_api2:GetRelatedPlaces' %}?person_id={{object.pk}}";
    window.addEventListener("map:init", function (event) {
    var map = event.detail.map;
    // Download GeoJSON data with Ajax
    fetch(dataurl)
      .then(function(resp) {
      return resp.json();
      })
      .then(function(data) {
      var jsonLayer = L.geoJson(data, {
        onEachFeature: function onEachFeature(feature, layer) {
          console.log(feature)
          var props = feature.properties;
        var content = `<div><h3><a href=${props.url}>${props.name}</a></h3><p>${props.kind}<br/>${props.relation_kind}</p></div>`;
        layer.bindPopup(content);
      }});
      jsonLayer.addTo(map);
      var bounds =  jsonLayer.getBounds();
      if (JSON.stringify(bounds['_northEast']) === JSON.stringify(bounds['_southWest'])) {
        map.setView(bounds['_northEast'], 12);
      } else {
        map.fitBounds(jsonLayer.getBounds());
      }
      
      });
    });
  </script>
{% endblock %}
