{% extends "theme/base.html" %}
{% load leaflet_tags %}
{% block scriptHeader %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/three@latest/build/three.min.js"></script>
    <script crossorigin src="https://unpkg.com/@acdh/network-visualization@latest/lib/network-visualization.umd.js"></script>
    {% leaflet_js %}
    {% leaflet_css %}
{% endblock %}
{% load staticfiles %}
{% load webpage_extras %}
{% load custom_tags %}
{% block title %}{{ object }}{% endblock %}
{% block content %}
<div id="contentDetails" class="container pt-5">
    <div class="row">
        <div class="col-md-6">
        <article class="card flat-style">
            <div class="entry-header pt-3">
                <div class="row justify-content-between">
                    <div class="col">
                        {% if prev.id %}
                        <a class="card-link preventity" href="{% url 'theme:person-detail' pk=prev.id %}"
                            title="{{ prev }}">
                            <i data-feather="chevron-left" title="previous"></i>
                        </a>
                        {% endif %}
                    </div>
                    <div class="col">
                    <a href="/apis/api2/entity/{{ object.pk }}/?format=json"><i data-feather="download"></i> </a>
                    </div>
                    <div class="col">
                        {% if next.id %}
                        <a class="card-link nextentity" href="{% url 'theme:person-detail' pk=next.id %}"
                            style="float:right" title="{{ next }}">
                            <i data-feather="chevron-right" title="next"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col pt-2">


                        <h2 class="pl-4">{{ object.name}}{%if object.first_name %},
                            {{ object.first_name}}{% endif %}</h2>
                        <p class="pl-4"> {{ profession }}, <abbr
                                title='geboren'>geb.</abbr> {{object.start_date_written }}{% if place_of_birth is not None %} in {{place_of_birth}}{% endif %}, <abbr
                                title='gestorben'>gest.</abbr> {{object.end_date_written }} {% if place_of_death is not None %} in {{place_of_death}} {% endif %}</p>
                    </div>
                </div>
            </div>
            <div class="card-body pt-2">
                <p class="bio">{{ main_text }}</p>
            </div>
        </article>
    </div>
    <div class="col-md-6">
            <article class="card flat-style">
                <div class="card-inner relentitiescard card-vertical  d-flex flex-column justify-content-between">
                    <h4>Networks</h4>
                    <div id="visualization" style="position: relative; background: #fafafa;"></div>
                    <form onsubmit="event.preventDefault();">
                        {% if related_places %}
                    <button class="btn btn-primary" name="add_pp" value="add_pp" onclick="getNetworkViz({{ object.pk }}, 'personplace', 'Place')">Person-Place</button>
                    {% endif %}
                    {% if related_institutions %}
                        <button class="btn btn-primary" name="add_pp" value="add_pp" onclick="getNetworkViz({{ object.pk }}, 'personinstitution', 'Institution')">Person-Institution</button>
                    {% endif %}
                    {% if related_persons %}
                        <button class="btn btn-primary" name="add_pp" value="add_pp" onclick="getNetworkViz({{ object.pk }}, 'personperson', 'Person')">Person-Person</button>
                    {% endif %}
                    </form>
                {% leaflet_map "main" %}
                </div>
                <div class="card-inner relentitiescard card-vertical  d-flex flex-column justify-content-between">
                    <div class="entry-header professioncats p-3">
                        {% if profession_categories is not None %}
                        {% for profession in profession_categories %}
                       <span class="professioncat badge badge-pill badge-primary">{{ profession.name }}</span>
                        {% endfor %}
                        {% endif %}
                    </div>
                    <div class="entry-content pl-3">
                        <h4>Links</h4>
                        <ul class="uris pl-0">{% for uri in object.uri_set.all %}
                            <li class="pl-0"><a target="_blank" rel="noopener noreferrer" href="{{uri}}">{{uri}}</a></li>
                            {% endfor %}
                        </ul>
                        <h4>Personen</h4>
                        <ul class="relentities">
                            {% for x in related_persons %}
                            <li class="pl-0">

                                {{ x.relation_type }} <i style="color: darkred">></i> <strong>{{ x.related_place }}</strong>
                                {% formated_daterange x.start_date_written x.end_date_written %}
                            </li>
                            {% endfor %}
                        </ul>
                        <h4>Orte</h4>
                        <ul class="relentities">
                            {% for x in related_places %}
                            <li class="pl-0">
                                {{ x.relation_type }} <i style="color: darkred">></i> <strong>{{ x.related_place }}</strong>
                                 {% formated_daterange x.start_date_written x.end_date_written %}
                            </li>
                            {% endfor %}
                        </ul>
                        <h4>Institutionen</h4>
                        <ul class="relentities">
                            {% for x in related_institutions %}
                            <li class="pl-0">
                                {{ x.relation_type }} <i style="color: darkred">></i> <strong>{{x.related_institution }}</strong>
                                {% formated_daterange x.start_date_written x.end_date_written %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </article>
        </div>
    </div>
</div>

{% endblock content %}
{% block scripts %}
    <script>
        const getNetworkViz = (pers_id, relationtype, t1) => {
           document.getElementById("visualization").style.height = "400px";
            const basePath = 'http://127.0.0.1:8000'
      const endpoint = '/apis/api/relations/'+relationtype
      const query = {
        format: 'json+net',
          related_person__id: pers_id,
      };
            if (relationtype == "personperson") {
                query['related_personA__id'] = pers_id
            }
      const url = new URL(endpoint, basePath)
      Object.keys(query).forEach(key => {
        url.searchParams.set(key, query[key])
      })
          fetch(url)
              .then(response => {
                  if (!response.ok) {
                      throw new Error(response.statusText)
                  }
                  return response.json()
              })
              .then(data => {
                  const edges = {}
                  const nodes = {}
                  const types = {edges: {}, nodes: {}}
                  data.results.forEach(relation => {
                      const {id, source, target, relation_type: relationType} = relation
                      edges[id] = {
                          id,
                          source: source.id,
                          target: target.id,
                          type: relationType.id,
                      }
                      nodes[source.id] = {
                          id: source.id,
                          label: source.label,
                          type: 'Person',
                      }
                      nodes[target.id] = {
                          id: target.id,
                          label: target.label,
                          type: t1,
                      }
                      types.edges[relationType.id] = {
                          id: relationType.id,
                          label: relationType.label,
                      }
                      types.nodes['Person'] = {
                          id: 'Person',
                          label: 'Person',
                          color: 'hotpink',
                      }
                      types.nodes['Place'] = {
                          id: 'Place',
                          label: 'Place',
                          color: 'rebeccapurple',
                      }
                      types.nodes['Institution'] = {
                          id: 'Institution',
                          label: 'Institution',
                          color: 'green',
                      }
                  })
                  ReactDOM.render(
                      React.createElement(NetworkVisualization.Visualization, {
                          graph: {
                              edges,
                              nodes,
                              types,
                          },
                      }),
                      document.getElementById('visualization')
                  )
              })
              .catch(error => {
                  console.error(error)
              })
      }
    </script>
    <script type="text/javascript">
      var dataurl = "{% url 'apis:apis_api2:GetRelatedPlaces' %}?person_id={{object.pk}}";
      window.addEventListener("map:init", function (event) {
        var map = event.detail.map;
        // Download GeoJSON data with Ajax
        fetch(dataurl)
          .then(function(resp) {
            return resp.json();
          })
          .then(function(data) {
            L.geoJson(data, {
              onEachFeature: function onEachFeature(feature, layer) {
                  console.log(feature)
                  var props = feature.properties;
                var content = `<div><h3><a href=${props.url}>${props.name}</a></h3><p>${props.kind}<br/>${props.relation_kind}</p></div>`;
                layer.bindPopup(content);
            }}).addTo(map);
          });
      });
    </script>
{% endblock %}